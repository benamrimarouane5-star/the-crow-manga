<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مانغا الغراب - موقع رسمي</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&family=Roboto:wght@300;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --dark-bg: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #1e3a5f);
        }
        * { box-sizing: border-box; }
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); 
            background-size: 400% 400%; 
            animation: gradientShift 15s ease infinite; 
            color: #333; 
            margin: 0; 
            padding: 0; 
            line-height: 1.6; 
            overflow-x: hidden;
            direction: rtl;
            transition: all 0.3s ease;
        }
        body.dark-mode {
            background: var(--dark-bg);
            color: #ddd;
        }
        @keyframes gradientShift { 
            0%{background-position:0% 50%} 
            50%{background-position:100% 50%} 
            100%{background-position:0% 50%} 
        }

        /* الشريط الجانبي */
        .sidebar {
            position: fixed;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 999;
        }
        .sidebar-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: none;
            font-size: 1.4em;
            color: #333;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-btn:hover { transform: scale(1.15); }
        .dark-mode .sidebar-btn { background: rgba(30,30,30,0.9); color: #fff; }

        /* Google Translate */
        #google_translate_element {
            position: fixed;
            top Star: 15px;
            right: 15px;
            z-index: 998;
        }
        .goog-te-gadget select { 
            background: rgba(255,255,255,0.9); 
            border: none; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* باقي التصميم */
        header, .description, .chapter, #comments, footer { margin: 20px auto; max-width: 900px; padding: 20px; border-radius: 12px; }
        header { background: rgba(0,0,0,0.8); color: #fff; text-align: center; }
        .cover { max-width: 100%; border-radius: 12px; }
        .chapters { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .chapter { background: rgba(255,255,255,0.95); width: 250px; text-align: center; }
        .read-btn { background: var(--primary-gradient); color: #fff; padding: 10px 20px; border-radius: 25px; text-decoration: none; }
        .dark-mode .chapter, .dark-mode #comments, .dark-mode .description { background: rgba(30,30,30,0.95) !important; color: #eee; }

        /* لوحة التحكم */
        #admin-panel {
            display: none;
            background: rgba(255,255,255,0.95);
            padding: 25px;
            margin: 30px auto;
            max-width: 900px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            direction: rtl;
        }
        .dark-mode #admin-panel { background: rgba(40,40,40,0.95); color: #eee; }
        #admin-panel h2 { color: #ff6b35; text-align: center; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; }
        .form-group button { background: #ff6b35; color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .chapter-item { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 8px; position: relative; }
        .chapter-item button { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; position: absolute; left: 10px; top: 10px; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { flex-direction: row; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 10px; border-radius: 50px; }
            .dark-mode .sidebar { background: rgba(30,30,30,0.9); }
            .sidebar-btn { width: 45px; height: 45px; font-size: 1.2em; }
            #admin-panel { margin: 20px 15px; padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- الأزرار الجانبية -->
    <div class="sidebar">
        <button class="sidebar-btn" id="dark-mode-btn" title="الوضع الليلي"><i class="fas fa-moon"></i></button>
        <button class="sidebar-btn" id="notification-btn" title="الإشعارات"><i class="fas fa-bell"></i></button>
        <button class="sidebar-btn" id="admin-panel-btn" title="لوحة تحكم الكاتب"><i class="fas fa-cog"></i></button>
    </div>

    <div id="google_translate_element"></div>

    <!-- المحتوى -->
    <header>
        <h1><i class="fas fa-book-open"></i> مانغا الغراب</h1>
        <img id="cover-img" src="images/cover.jpg" alt="غلاف" class="cover">
    </header>

    <section class="description" id="description-section">
        <h2><i class="fas fa-info-circle"></i> وصف القصة</h2>
        <p id="story-desc">جاري التحميل...</p>
        <h3><i class="fas fa-users"></i> الشخصيات الرئيسية</h3>
        <ul id="characters-list"></ul>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <p id="progress-text">جاري التحميل...</p>
    </section>

    <section class="chapters" id="chapters-section"></section>

    <section id="comments">
        <h2><i class="fas fa-comments"></i> اترك تعليقك</h2>
        <form id="comment-form">
            <input type="text" id="name" placeholder="اسمك" required maxlength="50">
            <textarea id="message" rows="4" placeholder="تعليقك..." required maxlength="500"></textarea>
            <button type="submit"><i class="fas fa-paper-plane"></i> أرسل</button>
        </form>
        <div id="comments-list"></div>
    </section>

    <footer>
        <div class="social-links">
            <a href="https://www.facebook.com/profile.php?id=61557602322000" target="_blank"><i class="fab fa-facebook"></i></a>
            <a href="https://www.instagram.com/the_crow_000" target="_blank"><i class="fab fa-instagram"></i></a>
        </div>
        <p>© 2025 عبد الدين بلال. جميع الحقوق محفوظة.</p>
    </footer>

    <!-- لوحة تحكم الكاتب -->
    <div id="admin-panel">
        <h2><i class="fas fa-crown"></i> لوحة تحكم الكاتب</h2>

        <div class="form-group">
            <label>رفع غلاف المانغا</label>
            <input type="file" id="cover-upload" accept="image/*">
            <button onclick="uploadCover()">رفع الغلاف</button>
        </div>

        <div class="form-group">
            <label>وصف القصة</label>
            <textarea id="story-desc-input" rows="4"></textarea>
            <button onclick="updateDescription()">تحديث الوصف</button>
        </div>

        <hr>

        <h3>إضافة فصل جديد</h3>
        <div class="form-group">
            <label>عنوان الفصل</label>
            <input type="text" id="chapter-title">
        </div>
        <div class="form-group">
            <label>وصف الفصل</label>
            <textarea id="chapter-desc" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label>صورة المعاينة</label>
            <input type="file" id="preview-upload" accept="image/*">
        </div>
        <div class="form-group">
            <label>ملف الفصل (ZIP أو PDF)</label>
            <input type="file" id="file-upload" accept=".zip,.pdf,.cbz,.cbr">
        </div>
        <button onclick="addChapter()">إضافة الفصل</button>

        <h3 style="margin-top:30px;">الفصول الحالية</h3>
        <div id="admin-chapters-list"></div>
    </div>

    <!-- Modal الفصل -->
    <div id="chapter-modal" style="display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.9);overflow:auto;padding:20px;">
        <span class="close" onclick="closeChapterModal()" style="color:white;position:absolute;top:15px;left:15px;font-size:28px;cursor:pointer;">×</span>
        <div id="chapter-content" style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;"></div>
    </div>

    <!-- Firebase Config -->
    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        const ADMIN_PASSWORD = 'Bilal.abdedine';
        let mangaData = { chapters: [] };
        let isAdmin = false;

        // تحميل البيانات
        async function loadData() {
            try {
                const doc = await db.collection('manga').doc('data').get();
                if (doc.exists) {
                    mangaData = doc.data();
                } else {
                    mangaData = { cover: 'images/cover.jpg', description: { ar: '...' }, characters: [], chapters: [] };
                    await db.collection('manga').doc('data').set(mangaData);
                }
                renderContent();
            } catch (e) { console.error(e); }
        }

        function renderContent() {
            document.getElementById('cover-img').src = mangaData.cover;
            document.getElementById('story-desc').textContent = mangaData.description.ar || 'لا يوجد وصف';
            document.getElementById('characters-list').innerHTML = (mangaData.characters || []).map(c => `<li><i class="fas fa-user"></i> ${c.name} - ${c.desc}</li>`).join('');
            document.getElementById('chapters-section').innerHTML = (mangaData.chapters || []).map((ch, i) => `
                <div class="chapter">
                    <h3><i class="fas fa-play"></i> ${ch.title}</h3>
                    <img src="${ch.preview}" loading="lazy">
                    <p>${ch.desc}</p>
                    <a href="#" class="read-btn" onclick="readChapter(${i});return false;">اقرأ الآن</a>
                    <div class="views-panel">المشاهدات: ${ch.views || 0}</div>
                </div>
            `).join('');

            const total = mangaData.chapters.length;
            const progress = total > 0 ? Math.min((total / 10) * 100, 100) : 0;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `أنت في الفصل ${total} من 10`;

            if (isAdmin) renderAdminPanel();
        }

        // قراءة الفصل
        async function readChapter(i) {
            const ch = mangaData.chapters[i];
            ch.views = (ch.views || 0) + 1;
            await db.collection('manga').doc('data').update({ [`chapters.${i}.views`]: ch.views });

            const modal = document.getElementById('chapter-modal');
            const content = document.getElementById('chapter-content');
            content.innerHTML = '<p style="color:white;">جاري التحميل...</p>';
            modal.style.display = 'block';

            try {
                const url = await storage.refFromURL(ch.fileUrl).getDownloadURL();
                if (ch.fileUrl.match(/\.(pdf|cbz|cbr)$/i)) {
                    content.innerHTML = `<iframe src="${url}" style="width:100%;height:90vh;border:none;"></iframe>`;
                } else {
                    const blob = await (await fetch(url)).blob();
                    const zip = new JSZip();
                    await zip.loadAsync(blob);
                    content.innerHTML = '';
                    for (const [path, entry] of Object.entries(zip.files)) {
                        if (!entry.dir && /\.(jpe?g|png|gif|webp)$/i.test(path)) {
                            const imgBlob = await entry.async('blob');
                            const img = document.createElement('img');
                            img.src = URL.createObjectURL(imgBlob);
                            img.style.maxWidth = '100%';
                            content.appendChild(img);
                        }
                    }
                }
            } catch (e) {
                content.innerHTML = `<p style="color:red;">خطأ: ${e.message}</p>`;
            }
        }

        function closeChapterModal() { document.getElementById('chapter-modal').style.display = 'none'; }

        // لوحة التحكم
        document.getElementById('admin-panel-btn').onclick = () => {
            const pass = prompt("كلمة المرور:");
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('story-desc-input').value = mangaData.description.ar || '';
                renderAdminPanel();
            } else if (pass !== null) {
                alert("كلمة المرور خاطئة!");
            }
        };

        // رفع الغلاف
        async function uploadCover() {
            const file = document.getElementById('cover-upload').files[0];
            if (!file) return alert("اختر صورة");
            const ref = storage.ref('covers/cover.jpg');
            await ref.put(file);
            const url = await ref.getDownloadURL();
            await db.collection('manga').doc('data').update({ cover: url });
            loadData();
        }

        // تحديث الوصف
        async function updateDescription() {
            const desc = document.getElementById('story-desc-input').value;
            await db.collection('manga').doc('data').update({ 'description.ar': desc });
            loadData();
        }

        // إضافة فصل
        async function addChapter() {
            const title = document.getElementById('chapter-title').value;
            const desc = document.getElementById('chapter-desc').value;
            const previewFile = document.getElementById('preview-upload').files[0];
            const file = document.getElementById('file-upload').files[0];
            if (!title || !desc || !previewFile || !file) return alert("املأ جميع الحقول");

            const previewRef = storage.ref('previews/' + Date.now() + '.jpg');
            await previewRef.put(previewFile);
            const previewUrl = await previewRef.getDownloadURL();

            const fileRef = storage.ref('chapters/' + Date.now() + '_' + file.name);
            await fileRef.put(file);
            const fileUrl = await fileRef.getDownloadURL();

            const newChapter = { title, desc, preview: previewUrl, fileUrl, views: 0 };
            mangaData.chapters.push(newChapter);
            await db.collection('manga').doc('data').set(mangaData);
            loadData();
            document.getElementById('chapter-title').value = '';
            document.getElementById('chapter-desc').value = '';
            document.getElementById('preview-upload').value = '';
            document.getElementById('file-upload').value = '';
        }

        // عرض الفصول في لوحة التحكم
        function renderAdminPanel() {
            document.getElementById('admin-chapters-list').innerHTML = mangaData.chapters.map((ch, i) => `
                <div class="chapter-item">
                    <strong>${ch.title}</strong><br>${ch.desc}
                    <button onclick="deleteChapter(${i})">حذف</button>
                </div>
            `).join('');
        }

        // حذف فصل
        async function deleteChapter(i) {
            if (confirm("هل تريد حذف هذا الفصل؟")) {
                mangaData.chapters.splice(i, 1);
                await db.collection('manga').doc('data').set(mangaData);
                loadData();
            }
        }

        // Dark Mode + Notifications + Translate + Comments
        document.getElementById('dark-mode-btn').onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        };
        if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

        document.getElementById('notification-btn').onclick = () => {
            Notification.requestPermission().then(p => p === 'granted' && new Notification("مرحباً!", { body: "الإشعارات مفعلة!" }));
        };

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'ar' }, 'google_translate_element');
        }
        const s = document.createElement('script');
        s.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        document.body.appendChild(s);

        const form = document.getElementById('comment-form');
        form.addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();
            if (name && message) {
                const comments = JSON.parse(localStorage.getItem('comments') || '[]');
                comments.push({ name, message, date: new Date().toLocaleString() });
                localStorage.setItem('comments', JSON.stringify(comments));
                displayComments();
                form.reset();
            }
        });

        function displayComments() {
            const comments = JSON.parse(localStorage.getItem('comments') || '[]');
            document.getElementById('comments-list').innerHTML = comments.map(c => 
                `<div class="comment"><strong>${c.name}</strong> (${c.date})<br>${c.message}</div>`
            ).join('');
        }

        window.onload = () => { loadData(); displayComments(); };
    </script>
</body>
</html>
