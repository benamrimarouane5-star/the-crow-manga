<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الكاتب - مانغا الغراب</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #e74c3c;
            --dark: #2d2d2d;
            --light: #f8f9fa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(0,0,0,0.7);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.2em; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }
        .section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input, textarea, select, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: none;
            font-family: inherit;
            transition: all 0.3s;
        }
        input, textarea, select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.7); }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        button {
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-small {
            width: auto;
            padding: 6px 12px;
            font-size: 0.9em;
            display: inline-block;
            margin: 0 5px;
        }
        .chapter-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chapter-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .chapter-info { flex: 1; min-width: 200px; }
        .chapter-actions { display: flex; gap: 5px; }
        .file-info { font-size: 0.9em; color: #aaa; margin-top: 5px; }
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover { border-color: var(--primary); background: rgba(102, 126, 234, 0.1); }
        .upload-area.dragover { border-color: var(--success); background: rgba(40, 167, 69, 0.2); }
        .lang-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .lang-tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .lang-tab.active { background: var(--primary); }
        .save-all { text-align: center; margin-top: 30px; }
        .save-all button { font-size: 1.2em; padding: 15px 40px; border-radius: 50px; }
        .password-prompt {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .password-box {
            background: white; color: #333; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .password-box input { background: #f8f9fa; color: #333; }
        .password-box button { background: var(--primary); margin-top: 15px; }

        /* نافذة التعديل */
        #edit-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;
        }
        #edit-content {
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;
        }
        #edit-content h3 { color: #fff; text-align: center; }
        .close-edit { position: absolute; top: 15px; right: 20px; font-size: 28px; color: #fff; cursor: pointer; }

        @media (max-width: 600px) {
            .chapter-item { flex-direction: column; align-items: flex-start; }
            .chapter-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>

    <!-- حماية بكلمة مرور -->
    <div id="password-prompt" class="password-prompt">
        <div class="password-box">
            <h2>لوحة تحكم الكاتب</h2>
            <p>أدخل كلمة المرور للمتابعة</p>
            <input type="password" id="admin-password" placeholder="كلمة المرور" autocomplete="off">
            <button onclick="checkAdminPassword()">دخول</button>
            <p style="margin-top:15px; font-size:0.9em; color:#666;">
                
            </p>
        </div>
    </div>

    <div class="container" id="admin-panel" style="display:none;">
        <h1>لوحة تحكم الكاتب</h1>

        <!-- تغيير الغلاف -->
        <div class="section">
            <h3>تغيير غلاف الموقع</h3>
            <div class="upload-area" onclick="document.getElementById('cover-upload').click()">
                <i class="fas fa-cloud-upload-alt fa-3x"></i>
                <p>اسحب الصورة هنا أو اضغط للرفع</p>
                <input type="file" id="cover-upload" accept="image/*" style="display:none;">
            </div>
            <div id="cover-preview" style="margin-top:15px; text-align:center;"></div>
        </div>

        <!-- إضافة فصل جديد -->
        <div class="section">
            <h3>إضافة فصل جديد</h3>
            <div class="lang-tabs">
                <div class="lang-tab active" data-lang="ar">العربية</div>
                <div class="lang-tab" data-lang="en">English</div>
                <div class="lang-tab" data-lang="fr">Français</div>
            </div>

            <div id="lang-ar">
                <input type="text" id="title-ar" placeholder="عنوان الفصل (عربي)">
                <textarea id="desc-ar" rows="2" placeholder="وصف مختصر (عربي)"></textarea>
            </div>
            <div id="lang-en" style="display:none;">
                <input type="text" id="title-en" placeholder="Chapter Title (English)">
                <textarea id="desc-en" rows="2" placeholder="Short description (English)"></textarea>
            </div>
            <div id="lang-fr" style="display:none;">
                <input type="text" id="title-fr" placeholder="Titre du chapitre (Français)">
                <textarea id="desc-fr" rows="2" placeholder="Description courte (Français)"></textarea>
            </div>

            <div class="upload-area" onclick="document.getElementById('preview-upload').click()">
                <i class="fas fa-image fa-2x"></i><br>
                <span>صورة معاينة الفصل</span>
                <input type="file" id="preview-upload" accept="image/*" style="display:none;">
            </div>
            <div id="preview-preview" style="text-align:center; margin:10px 0;"></div>

            <div class="upload-area" onclick="document.getElementById('chapter-file').click()">
                <i class="fas fa-file-archive fa-2x"></i><br>
                <span>ملف الفصل (.zip أو .pdf)</span>
                <input type="file" id="chapter-file" accept=".zip,.pdf" style="display:none;">
            </div>
            <div id="file-info" class="file-info"></div>

            <button onclick="addChapter()" class="btn-success">إضافة الفصل</button>
        </div>

        <!-- قائمة الفصول -->
        <div class="section">
            <h3>الفصول الحالية (<span id="chapter-count">0</span>)</h3>
            <div id="chapters-list"></div>
        </div>

        <!-- حفظ الكل -->
        <div class="save-all">
            <button onclick="saveAllData()" class="btn-success">
                حفظ جميع البيانات وتحميل manga-data.json
            </button>
            <p style="margin-top:10px; font-size:0.9em; color:#aaa;">
                → ارفع الملف إلى موقع القراءة بعد التحميل
            </p>
        </div>
    </div>

    <!-- نافذة تعديل الفصل -->
    <div id="edit-modal">
        <div id="edit-content">
            <span class="close-edit" onclick="closeEditModal()">×</span>
            <h3>تعديل الفصل</h3>
            <div class="lang-tabs">
                <div class="lang-tab active" data-lang="ar">العربية</div>
                <div class="lang-tab" data-lang="en">English</div>
                <div class="lang-tab" data-lang="fr">Français</div>
            </div>

            <div id="edit-lang-ar">
                <input type="text" id="edit-title-ar" placeholder="عنوان الفصل (عربي)">
                <textarea id="edit-desc-ar" rows="2" placeholder="وصف مختصر (عربي)"></textarea>
            </div>
            <div id="edit-lang-en" style="display:none;">
                <input type="text" id="edit-title-en" placeholder="Chapter Title (English)">
                <textarea id="edit-desc-en" rows="2" placeholder="Short description (English)"></textarea>
            </div>
            <div id="edit-lang-fr" style="display:none;">
                <input type="text" id="edit-title-fr" placeholder="Titre du chapitre (Français)">
                <textarea id="edit-desc-fr" rows="2" placeholder="Description courte (Français)"></textarea>
            </div>

            <div class="upload-area" onclick="document.getElementById('edit-preview-upload').click()">
                <i class="fas fa-image fa-2x"></i><br>
                <span>تغيير صورة المعاينة</span>
                <input type="file" id="edit-preview-upload" accept="image/*" style="display:none;">
            </div>
            <div id="edit-preview-preview" style="text-align:center; margin:10px 0;"></div>

            <div class="upload-area" onclick="document.getElementById('edit-chapter-file').click()">
                <i class="fas fa-file-archive fa-2x"></i><br>
                <span>تغيير ملف الفصل</span>
                <input type="file" id="edit-chapter-file" accept=".zip,.pdf" style="display:none;">
            </div>
            <div id="edit-file-info" class="file-info"></div>

            <button onclick="saveEditedChapter()" class="btn-success">حفظ التغييرات</button>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'Bilal.abdedine';
        let mangaData = { cover: '', description: { ar: '', en: '', fr: '' }, chapters: [] };
        let editingIndex = -1;

        function checkAdminPassword() {
            const input = document.getElementById('admin-password').value.trim();
            if (input === ADMIN_PASSWORD) {
                document.getElementById('password-prompt').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadSavedData();
            } else {
                alert('كلمة المرور خاطئة!');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('mangaAdminData');
            if (saved) {
                try {
                    mangaData = JSON.parse(saved);
                    updateCoverPreview();
                    updateChaptersList();
                } catch (e) { console.error('خطأ في تحميل البيانات'); }
            }
        }

        function saveTemp() {
            localStorage.setItem('mangaAdminData', JSON.stringify(mangaData));
        }

        // === تبديل اللغات ===
        function setupLangTabs(containerId) {
            document.querySelectorAll(`#${containerId} .lang-tab`).forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll(`#${containerId} .lang-tab`).forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const prefix = containerId === 'admin-panel' ? 'lang-' : 'edit-lang-';
                    document.querySelectorAll(`#${containerId} [id^="${prefix}"]`).forEach(div => div.style.display = 'none');
                    document.getElementById(prefix + tab.dataset.lang).style.display = 'block';
                });
            });
        }
        setupLangTabs('admin-panel');
        setupLangTabs('edit-content');

        // === رفع الغلاف ===
        document.getElementById('cover-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) readFile(file, 'dataURL', result => {
                mangaData.cover = result;
                updateCoverPreview();
                saveTemp();
            });
        });

        function updateCoverPreview() {
            const preview = document.getElementById('cover-preview');
            preview.innerHTML = mangaData.cover 
                ? `<img src="${mangaData.cover}" style="max-width:200px; border-radius:12px; margin-top:10px;">`
                : '<p style="color:#aaa;">لا يوجد غلاف</p>';
        }

        // === رفع صورة المعاينة ===
        document.getElementById('preview-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) readFile(file, 'dataURL', result => {
                document.getElementById('preview-preview').innerHTML = `<img src="${result}" style="max-width:120px; border-radius:8px; margin:10px;">`;
            });
        });

        // === رفع ملف الفصل ===
        document.getElementById('chapter-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('file-info').textContent = `الملف: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
            }
        });

        // === قراءة الملف ===
        function readFile(file, as, callback) {
            const reader = new FileReader();
            reader.onload = e => callback(e.target.result);
            if (as === 'dataURL') reader.readAsDataURL(file);
        }

        // === إضافة فصل جديد ===
        function addChapter() {
            const title = { ar: document.getElementById('title-ar').value.trim(), en: document.getElementById('title-en').value.trim(), fr: document.getElementById('title-fr').value.trim() };
            const desc = { ar: document.getElementById('desc-ar').value.trim(), en: document.getElementById('desc-en').value.trim(), fr: document.getElementById('desc-fr').value.trim() };
            const previewFile = document.getElementById('preview-upload').files[0];
            const chapterFile = document.getElementById('chapter-file').files[0];

            if (!title.ar || !desc.ar || !previewFile || !chapterFile) return alert('أكمل جميع الحقول!');

            const r1 = new FileReader();
            const r2 = new FileReader();
            r1.onload = e1 => {
                r2.onload = e2 => {
                    mangaData.chapters.push({ title, desc, preview: e1.target.result, chapterFile: e2.target.result, views: 0 });
                    saveTemp();
                    updateChaptersList();
                    clearChapterForm();
                    alert('تم إضافة الفصل بنجاح!');
                };
                r2.readAsDataURL(chapterFile);
            };
            r1.readAsDataURL(previewFile);
        }

        function clearChapterForm() {
            document.querySelectorAll('#title-ar, #title-en, #title-fr, #desc-ar, #desc-en, #desc-fr').forEach(el => el.value = '');
            document.getElementById('preview-upload').value = '';
            document.getElementById('chapter-file').value = '';
            document.getElementById('preview-preview').innerHTML = '';
            document.getElementById('file-info').textContent = '';
        }

        // === عرض الفصول ===
        function updateChaptersList() {
            const list = document.getElementById('chapters-list');
            document.getElementById('chapter-count').textContent = mangaData.chapters.length;
            list.innerHTML = mangaData.chapters.map((ch, i) => `
                <div class="chapter-item">
                    <img src="${ch.preview}" alt="preview">
                    <div class="chapter-info">
                        <strong>${ch.title.ar || ch.title.en}</strong><br>
                        <span style="font-size:0.9em; color:#ccc;">${ch.desc.ar || ch.desc.en}</span>
                    </div>
                    <div class="chapter-actions">
                        <button class="btn-small" style="background:#ffc107;" onclick="openEditModal(${i})">تعديل</button>
                        <button class="btn-small btn-danger" onclick="deleteChapter(${i})">حذف</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteChapter(i) {
            if (confirm('هل أنت متأكد من حذف هذا الفصل؟')) {
                mangaData.chapters.splice(i, 1);
                saveTemp();
                updateChaptersList();
            }
        }

        // === فتح نافذة التعديل ===
        function openEditModal(i) {
            editingIndex = i;
            const ch = mangaData.chapters[i];
            document.getElementById('edit-title-ar').value = ch.title.ar;
            document.getElementById('edit-title-en').value = ch.title.en;
            document.getElementById('edit-title-fr').value = ch.title.fr;
            document.getElementById('edit-desc-ar').value = ch.desc.ar;
            document.getElementById('edit-desc-en').value = ch.desc.en;
            document.getElementById('edit-desc-fr').value = ch.desc.fr;
            document.getElementById('edit-preview-preview').innerHTML = `<img src="${ch.preview}" style="max-width:120px; border-radius:8px; margin:10px;">`;
            document.getElementById('edit-file-info').textContent = `الملف الحالي: ${ch.chapterFile.split(';')[0].split(':')[1]} (${(ch.chapterFile.length/1024/1024).toFixed(2)} MB تقريبًا)`;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingIndex = -1;
        }

        // === حفظ التعديلات ===
        function saveEditedChapter() {
            if (editingIndex === -1) return;

            const title = {
                ar: document.getElementById('edit-title-ar').value.trim(),
                en: document.getElementById('edit-title-en').value.trim(),
                fr: document.getElementById('edit-title-fr').value.trim()
            };
            const desc = {
                ar: document.getElementById('edit-desc-ar').value.trim(),
                en: document.getElementById('edit-desc-en').value.trim(),
                fr: document.getElementById('edit-desc-fr').value.trim()
            };

            if (!title.ar || !desc.ar) return alert('العنوان والوصف بالعربية مطلوبان!');

            const previewFile = document.getElementById('edit-preview-upload').files[0];
            const chapterFile = document.getElementById('edit-chapter-file').files[0];

            const update = (preview, file) => {
                mangaData.chapters[editingIndex] = { ...mangaData.chapters[editingIndex], title, desc, preview, chapterFile: file };
                saveTemp();
                updateChaptersList();
                closeEditModal();
                alert('تم حفظ التغييرات بنجاح!');
            };

            if (previewFile && chapterFile) {
                const r1 = new FileReader();
                const r2 = new FileReader();
                r1.onload = e1 => { r2.onload = e2 => update(e1.target.result, e2.target.result); r2.readAsDataURL(chapterFile); };
                r1.readAsDataURL(previewFile);
            } else if (previewFile) {
                const r = new FileReader();
                r.onload = e => { update(e.target.result, mangaData.chapters[editingIndex].chapterFile); };
                r.readAsDataURL(previewFile);
            } else if (chapterFile) {
                const r = new FileReader();
                r.onload = e => { update(mangaData.chapters[editingIndex].preview, e.target.result); };
                r.readAsDataURL(chapterFile);
            } else {
                update(mangaData.chapters[editingIndex].preview, mangaData.chapters[editingIndex].chapterFile);
            }
        }

        // === رفع ملفات التعديل ===
        document.getElementById('edit-preview-upload').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) readFile(file, 'dataURL', result => {
                document.getElementById('edit-preview-preview').innerHTML = `<img src="${result}" style="max-width:120px; border-radius:8px; margin:10px;">`;
            });
        });

        document.getElementById('edit-chapter-file').addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('edit-file-info').textContent = `الملف الجديد: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
            }
        });

        // === حفظ الكل كـ JSON ===
        function saveAllData() {
            if (!mangaData.cover) return alert('أضف غلافًا أولاً!');
            if (mangaData.chapters.length === 0) return alert('أضف فصلًا واحدًا على الأقل!');

            const blob = new Blob([JSON.stringify(mangaData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'manga-data.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('تم حفظ manga-data.json بنجاح!\nارفع الملف إلى موقع القراءة');
        }

        // === دعم السحب والإفلات ===
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            document.body.addEventListener(event, e => e.preventDefault());
        });
        document.querySelectorAll('.upload-area').forEach(area => {
            ['dragenter', 'dragover'].forEach(e => area.addEventListener(e, () => area.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(e => area.addEventListener(e, () => area.classList.remove('dragover')));
        });
    </script>
</body>
</html>
